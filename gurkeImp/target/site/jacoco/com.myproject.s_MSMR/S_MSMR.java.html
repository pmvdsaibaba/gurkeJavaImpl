<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>S_MSMR.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gurkeImp</a> &gt; <a href="index.source.html" class="el_package">com.myproject.s_MSMR</a> &gt; <span class="el_source">S_MSMR.java</span></div><h1>S_MSMR.java</h1><pre class="source lang-java linenums">package com.myproject.s_MSMR;

import com.myproject.staticUBKem.BKGen;
import com.myproject.signatureScheme.SignatureScheme;

import com.myproject.staticUBKem.BKEnc;
import com.myproject.staticUBKem.BKEnc.EncapsulationReturn;
import com.myproject.staticUBKem.BKEnc.EncapsulationResult;
import com.myproject.staticUBKem.BKFin;
import com.myproject.staticUBKem.BKFin.FinResult;
import com.myproject.staticUBKem.BKDec;
import com.myproject.staticUBKem.BKDec.DecResult;

import java.security.InvalidAlgorithmParameterException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L20">public class S_MSMR {</span>

    public static class SenderState {
        public int id;
        public int nS;
        public int nR;
        public byte[] ek;
        public byte[] ssk;

<span class="fc" id="L29">        public SenderState(int id, int nS, int nR, byte[] ek, byte[] ssk) {</span>
<span class="fc" id="L30">            this.id = id;</span>
<span class="fc" id="L31">            this.nS = nS;</span>
<span class="fc" id="L32">            this.nR = nR;</span>
<span class="fc" id="L33">            this.ek = ek;</span>
<span class="fc" id="L34">            this.ssk = ssk;</span>
<span class="fc" id="L35">        }</span>
    }

    public static class ReceiverState {
        public int nS;
        public int nR;
        public List&lt;ReceiverInfo&gt; senderInfoList;

<span class="fc" id="L43">        public ReceiverState(int nS, int nR, List&lt;ReceiverInfo&gt; senderInfoList) {</span>
<span class="fc" id="L44">            this.nS = nS;</span>
<span class="fc" id="L45">            this.nR = nR;</span>
<span class="fc" id="L46">            this.senderInfoList = senderInfoList;</span>
<span class="fc" id="L47">        }</span>

        public static class ReceiverInfo {
            public byte[] dk;
            public byte[] svk;

<span class="fc" id="L53">            public ReceiverInfo(byte[] dk, byte[] svk) {</span>
<span class="fc" id="L54">                this.dk = dk;</span>
<span class="fc" id="L55">                this.svk = svk;</span>
<span class="fc" id="L56">            }</span>
        }
    }

    public static class InitResult {
        public List&lt;SenderState&gt; senderStates;
        public List&lt;ReceiverState&gt; receiverStates;

<span class="fc" id="L64">        public InitResult(List&lt;SenderState&gt; senderStates, List&lt;ReceiverState&gt; receiverStates) {</span>
<span class="fc" id="L65">            this.senderStates = senderStates;</span>
<span class="fc" id="L66">            this.receiverStates = receiverStates;</span>
<span class="fc" id="L67">        }</span>
    }

    public static InitResult procInit(int nS, int nR) throws Exception {
<span class="fc" id="L71">        List&lt;SenderState&gt; senderStates = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L72">        List&lt;List&lt;ReceiverState.ReceiverInfo&gt;&gt; Sj = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">        for (int j = 0; j &lt; nR; j++) {</span>
<span class="fc" id="L75">            Sj.add(new ArrayList&lt;&gt;());</span>
        }

<span class="fc bfc" id="L78" title="All 2 branches covered.">        for (int i = 0; i &lt; nS; i++) {</span>

<span class="fc" id="L80">            List&lt;byte[]&gt; bkResult = BKGen.gen(nR);</span>
<span class="fc" id="L81">            byte[] ek = bkResult.get(0);</span>
<span class="fc" id="L82">            List&lt;byte[]&gt; dks = bkResult.subList(1, bkResult.size());</span>

<span class="fc" id="L84">            SignatureScheme.KeyPair sigKeyPair = SignatureScheme.gen();</span>
<span class="fc" id="L85">            byte[] svk = sigKeyPair.getVk();</span>
<span class="fc" id="L86">            byte[] ssk = sigKeyPair.getSk();</span>

<span class="fc" id="L88">            SenderState senderState = new SenderState(i, nS, nR, ek, ssk);</span>
<span class="fc" id="L89">            senderStates.add(senderState);</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">            for (int j = 0; j &lt; nR; j++) {</span>
<span class="fc" id="L92">                ReceiverState.ReceiverInfo info = new ReceiverState.ReceiverInfo(dks.get(j), svk);</span>
<span class="fc" id="L93">                Sj.get(j).add(info);</span>
            }
        }

<span class="fc" id="L97">        List&lt;ReceiverState&gt; receiverStates = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (int j = 0; j &lt; nR; j++) {</span>
<span class="fc" id="L99">            ReceiverState receiverState = new ReceiverState(nS, nR, Sj.get(j));</span>
<span class="fc" id="L100">            receiverStates.add(receiverState);</span>
        }

<span class="fc" id="L103">        return new InitResult(senderStates, receiverStates);</span>
    }


    // Implements: procSnd
    public static class Ciphertext {
        public int senderId;
        public byte[] cPrime;
        public byte[] svkPrime;
        public byte[] signature;

<span class="fc" id="L114">        public Ciphertext(int senderId, byte[] cPrime, byte[] svkPrime, byte[] signature) {</span>
<span class="fc" id="L115">            this.senderId = senderId;</span>
<span class="fc" id="L116">            this.cPrime = cPrime;</span>
<span class="fc" id="L117">            this.svkPrime = svkPrime;</span>
<span class="fc" id="L118">            this.signature = signature;</span>
<span class="fc" id="L119">        }</span>
    }

    public static class ProcSndResult {
        public SenderState updatedSenderState;
        public Ciphertext ciphertext;
        public byte[] key;
        public Kid kid;

<span class="fc" id="L128">        public ProcSndResult(SenderState updatedSenderState, Ciphertext ciphertext, byte[] key, Kid kid) {</span>
<span class="fc" id="L129">            this.updatedSenderState = updatedSenderState;</span>
<span class="fc" id="L130">            this.ciphertext = ciphertext;</span>
<span class="fc" id="L131">            this.key = key;</span>
<span class="fc" id="L132">            this.kid = kid;</span>
<span class="fc" id="L133">        }</span>
    }

    public static class Kid {
        public byte[] id;
        public int senderId;
        public int nS;
        public int nR;

<span class="fc" id="L142">        public Kid(byte[] id, int senderId, int nS, int nR) {</span>
<span class="fc" id="L143">            this.id = id;</span>
<span class="fc" id="L144">            this.senderId = senderId;</span>
<span class="fc" id="L145">            this.nS = nS;</span>
<span class="fc" id="L146">            this.nR = nR;</span>
<span class="fc" id="L147">        }</span>
    }

    public static ProcSndResult procSnd(SenderState st, byte[] ad) throws Exception {
<span class="fc" id="L151">        int i = st.id;</span>
<span class="fc" id="L152">        int nS = st.nS;</span>
<span class="fc" id="L153">        int nR = st.nR;</span>
<span class="fc" id="L154">        byte[] ek = st.ek;</span>
<span class="fc" id="L155">        byte[] ssk = st.ssk;</span>

<span class="fc" id="L157">        EncapsulationReturn encRet = BKEnc.enc(ek);</span>
<span class="fc" id="L158">        EncapsulationResult u = encRet.getU();</span>
<span class="fc" id="L159">        byte[] cPrime = encRet.getC();</span>

<span class="fc" id="L161">        SignatureScheme.KeyPair newSigKeys = SignatureScheme.gen();</span>
<span class="fc" id="L162">        byte[] svkPrime = newSigKeys.getVk();</span>
<span class="fc" id="L163">        byte[] sskPrime = newSigKeys.getSk();</span>


<span class="fc" id="L166">        byte[] toSign = concatAll(ad, intToBytes(i), cPrime, svkPrime);</span>
<span class="fc" id="L167">        byte[] sigma = SignatureScheme.sgn(ssk, toSign);</span>


<span class="fc" id="L170">        Ciphertext ciphertext = new Ciphertext(i, cPrime, svkPrime, sigma);</span>

<span class="fc" id="L172">        byte[] cConcat = concatAll(ad, intToBytes(i), cPrime, svkPrime, sigma);</span>
<span class="fc" id="L173">        FinResult finResult = BKFin.fin(u, cConcat);</span>
<span class="fc" id="L174">        byte[] newEk = finResult.getEk();</span>
<span class="fc" id="L175">        byte[] k = finResult.getK();</span>

        // Kid kid = new Kid(finResult.getEk(), i, nS, nR); // Assuming ek = id
<span class="fc" id="L178">        Kid kid = new Kid(finResult.getK(), i, nS, nR); // Assuming k = id</span>

<span class="fc" id="L180">        SenderState updatedSt = new SenderState(i, nS, nR, newEk, sskPrime);</span>

<span class="fc" id="L182">        return new ProcSndResult(updatedSt, ciphertext, k, kid);</span>
    }

    // Utility to concatenate multiple byte arrays
    private static byte[] concatAll(byte[]... arrays) {
<span class="fc" id="L187">        int totalLength = 0;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">        for (byte[] array : arrays) {</span>
<span class="fc" id="L189">            totalLength += array.length;</span>
        }
<span class="fc" id="L191">        byte[] result = new byte[totalLength];</span>
<span class="fc" id="L192">        int currentIndex = 0;</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">        for (byte[] array : arrays) {</span>
<span class="fc" id="L194">            System.arraycopy(array, 0, result, currentIndex, array.length);</span>
<span class="fc" id="L195">            currentIndex += array.length;</span>
        }
<span class="fc" id="L197">        return result;</span>
    }

    // Utility to convert int to byte[]
    private static byte[] intToBytes(int value) {
<span class="fc" id="L202">        return new byte[] {</span>
            (byte) (value &gt;&gt;&gt; 24),
            (byte) (value &gt;&gt;&gt; 16),
            (byte) (value &gt;&gt;&gt; 8),
            (byte) value
        };
    }

    // Implements: procRcv
    public static class ProcRcvResult {
        public ReceiverState updatedState;
        public byte[] k;
        public Kid kid;

<span class="fc" id="L216">        public ProcRcvResult(ReceiverState updatedState, byte[] k, Kid kid) {</span>
<span class="fc" id="L217">            this.updatedState = updatedState;</span>
<span class="fc" id="L218">            this.k = k;</span>
<span class="fc" id="L219">            this.kid = kid;</span>
<span class="fc" id="L220">        }</span>
    }

    public static class ProcRcvFailure {
        public ReceiverState updatedState;

<span class="nc" id="L226">        public ProcRcvFailure(ReceiverState updatedState) {</span>
<span class="nc" id="L227">            this.updatedState = updatedState;</span>
<span class="nc" id="L228">        }</span>
    }

    public static Object procRcv(ReceiverState st, byte[] ad, Ciphertext c) throws Exception {
<span class="fc" id="L232">        int nS = st.nS;</span>
<span class="fc" id="L233">        int nR = st.nR;</span>
<span class="fc" id="L234">        List&lt;ReceiverState.ReceiverInfo&gt; senderList = new ArrayList&lt;&gt;(st.senderInfoList);</span>

<span class="fc" id="L236">        int i = c.senderId;</span>
<span class="fc" id="L237">        byte[] cPrime = c.cPrime;</span>
<span class="fc" id="L238">        byte[] svkPrime = c.svkPrime;</span>
<span class="fc" id="L239">        byte[] sigma = c.signature;</span>

        // Get (dk, svk)
<span class="fc" id="L242">        ReceiverState.ReceiverInfo info = senderList.get(i);</span>
<span class="fc" id="L243">        byte[] dk = info.dk;</span>
<span class="fc" id="L244">        byte[] svk = info.svk;</span>

        // Verify signature
<span class="fc" id="L247">        byte[] signedMessage = concatAll(ad, intToBytes(i), cPrime, svkPrime);</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">        if (!SignatureScheme.vfy(svk, signedMessage, sigma)) {</span>
<span class="nc" id="L249">            return new ProcRcvFailure(st);  // Return (st, ⊥)</span>
        }

        // (dk, (k, id)) ← BK.dec(dk, (ad, c), c′)
<span class="fc" id="L253">        byte[] fullC = concatAll(ad, intToBytes(i), cPrime, svkPrime, sigma);</span>
<span class="fc" id="L254">        DecResult decResult = BKDec.dec(dk, fullC, cPrime);</span>

<span class="fc" id="L256">        byte[] newDk = decResult.getDk();</span>
<span class="fc" id="L257">        byte[] k = decResult.getK();</span>

<span class="fc" id="L259">        Kid kid = new Kid(k, i, nS, nR);</span>

<span class="fc" id="L261">        senderList.set(i, new ReceiverState.ReceiverInfo(newDk, svkPrime));</span>

<span class="fc" id="L263">        ReceiverState newState = new ReceiverState(nS, nR, senderList);</span>

<span class="fc" id="L265">        return new ProcRcvResult(newState, k, kid);</span>
    }

    public static int procIni(Kid kid) {
<span class="nc" id="L269">        return kid.senderId;</span>
    }

    public static int procMemS(Kid kid) {
<span class="nc" id="L273">        return kid.nS;</span>
    }

    public static int procMemR(Kid kid) {
<span class="nc" id="L277">        return kid.nR;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>